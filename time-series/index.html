<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-12-20 Wed 18:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Time Series Data Analysis</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Qike Max Li" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="../styles/readtheorg/css/readtheorg.css"/>
<script src="../styles/readtheorg/js/jquery.min.js"></script>
<script src="../styles/readtheorg/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../styles/readtheorg/js/jquery.stickytableheaders.js"></script>
<script type="text/javascript" src="../styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Time Series Data Analysis</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orge0f79a3">1. Exploratory data analysis (EDA)</a>
<ul>
<li><a href="#orga74a58f">1.1. Get a feeling of the data</a></li>
<li><a href="#org64d25fd">1.2. Initial plots</a>
<ul>
<li><a href="#orge705251">1.2.1. Plot the time series data with different colors for clear days and cloudy days.</a></li>
<li><a href="#org21baa20">1.2.2. Plot car counts against weather</a></li>
<li><a href="#org0464117">1.2.3. Plot weather of clear days and cloudy days</a></li>
</ul>
</li>
<li><a href="#org453cb3f">1.3. Single-year data analysis</a>
<ul>
<li><a href="#org1324281">1.3.1. Year 2010</a></li>
<li><a href="#org89128a4">1.3.2. Year 2014</a></li>
</ul>
</li>
<li><a href="#org9be97b4">1.4. Group data points</a>
<ul>
<li><a href="#orgf75df38">1.4.1. Group by day of week</a></li>
<li><a href="#org965227f">1.4.2. Group by day of month</a></li>
<li><a href="#org93a6a5b">1.4.3. Group by day of year</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org8657f26">2. Analysis in Frequency Domain</a>
<ul>
<li><a href="#org0eec7d3">2.1. Imputation</a></li>
<li><a href="#org41d23ec">2.2. Plot the time series with imputed data points</a></li>
<li><a href="#org50709bf">2.3. Decompose the series</a></li>
<li><a href="#orgf32e48f">2.4. Spectrum analysis</a>
<ul>
<li><a href="#orgb7d0023">2.4.1. Detrend</a></li>
<li><a href="#org774262e">2.4.2. Spectrum Analysis</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org494cdad">3. Fit ARIMA models</a>
<ul>
<li><a href="#orgb36e426">3.1. ARIMA \((1,0,1)×(0,1,0)_{92}\)</a></li>
<li><a href="#org13239d4">3.2. Choose ARIMA models</a></li>
</ul>
</li>
<li><a href="#org700031d">4. Future analysis</a></li>
</ul>
</div>
</div>


<div id="outline-container-orge0f79a3" class="outline-2">
<h2 id="orge0f79a3"><span class="section-number-2">1</span> Exploratory data analysis (EDA)</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-orga74a58f" class="outline-3">
<h3 id="orga74a58f"><span class="section-number-3">1.1</span> Get a feeling of the data</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">load the libraries</span>
<span style="color: #BFEBBF;">library</span>(tidyverse)
<span style="color: #BFEBBF;">library</span>(ggplot2)
<span style="color: #BFEBBF;">library</span>(astsa)
<span style="color: #BFEBBF;">library</span>(imputeTS)                       <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">to impute missing values</span>
<span style="color: #BFEBBF;">library</span>(lubridate)
<span style="color: #BFEBBF;">library</span>(parallel)                       <span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">to parallelize computation</span>

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">read in data</span>
dat1 <span style="color: #BFEBBF;">&lt;-</span> suppressMessages(read_csv(<span style="color: #CC9393;">'../Data/data.csv'</span>)) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(day.of.week = factor(day.of.week,
                                   levels = c( <span style="color: #CC9393;">"Monday"</span>, 
                                               <span style="color: #CC9393;">"Tuesday"</span>,
                                               <span style="color: #CC9393;">"Wednesday"</span>,
                                               <span style="color: #CC9393;">"Thursday"</span>,
                                               <span style="color: #CC9393;">"Friday"</span>,
                                               <span style="color: #CC9393;">"Saturday"</span>,
                                              <span style="color: #CC9393;">"Sunday"</span>)),
           cloud.indicator = factor(cloud.indicator))
</pre>
</div>

<ul class="org-ul">
<li>Print the first few rows of the data</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">dat1
</pre>
</div>

<pre class="example">
# A tibble: 2,373 x 5
         date day.of.week car.count weather cloud.indicator
       &lt;date&gt;      &lt;fctr&gt;     &lt;int&gt;   &lt;dbl&gt;          &lt;fctr&gt;
 1 2010-01-01      Friday       101     0.1           clear
 2 2010-01-02    Saturday        34     0.2          cloudy
 3 2010-01-03      Sunday       113     0.4           clear
 4 2010-01-04      Monday         5     0.6          cloudy
 5 2010-01-05     Tuesday       124     0.1           clear
 6 2010-01-06   Wednesday       104    -0.1           clear
 7 2010-01-07    Thursday        81    -1.0           clear
 8 2010-01-08      Friday        67    -0.3          cloudy
 9 2010-01-09    Saturday        89     0.2          cloudy
10 2010-01-10      Sunday       132     1.4           clear
# ... with 2,363 more rows
</pre>

<ul class="org-ul">
<li>Summarize each column of the data</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">summary(dat1)
</pre>
</div>

<pre class="example">
      date               day.of.week    car.count        weather         
 Min.   :2010-01-01   Monday   :339   Min.   :  0.0   Min.   :-3.200000  
 1st Qu.:2011-08-17   Tuesday  :339   1st Qu.: 81.0   1st Qu.:-0.700000  
 Median :2013-04-01   Wednesday:339   Median :122.0   Median : 0.000000  
 Mean   :2013-04-01   Thursday :339   Mean   :112.8   Mean   : 0.008512  
 3rd Qu.:2014-11-15   Friday   :339   3rd Qu.:152.0   3rd Qu.: 0.700000  
 Max.   :2016-06-30   Saturday :339   Max.   :239.0   Max.   : 4.300000  
                      Sunday   :339                                      
 cloud.indicator
 clear :1353    
 cloudy:1020
</pre>

<p>
There are five columns in the data, and approximately 40% of the data are collected from cloudy days. It is unclear how weather affects car counts. 
</p>
</div>
</div>
<div id="outline-container-org64d25fd" class="outline-3">
<h3 id="org64d25fd"><span class="section-number-3">1.2</span> Initial plots</h3>
<div class="outline-text-3" id="text-1-2">
</div><div id="outline-container-orge705251" class="outline-4">
<h4 id="orge705251"><span class="section-number-4">1.2.1</span> Plot the time series data with different colors for clear days and cloudy days.</h4>
<div class="outline-text-4" id="text-1-2-1">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = date, y = car.count,
               color = cloud.indicator)) +
    geom_path() +
    theme_bw(base_size = 18) +
    theme(legend.position = <span style="color: #CC9393;">'bottom'</span>)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-ini.png" alt="fig-ini.png" />
</p>
</div>

<ul class="org-ul">
<li>Impressions:
<ul class="org-ul">
<li>Data of the clear days and data of the cloudy days don't follow the same distribution.</li>
<li>Data of the cloudy days are highly variable.</li>
<li>Cyclical behavior.</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org21baa20" class="outline-4">
<h4 id="org21baa20"><span class="section-number-4">1.2.2</span> Plot car counts against weather</h4>
<div class="outline-text-4" id="text-1-2-2">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = weather, y = car.count)) +
    geom_point() +
    geom_smooth() +
    theme_bw(base_size = 18) +
    theme(legend.position = <span style="color: #CC9393;">'bottom'</span>)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-weather-car.png" alt="fig-weather-car.png" />
</p>
</div>

<p>
There doesn't seem to be a relationship between weather and car counts.
</p>
</div>
</div>
<div id="outline-container-org0464117" class="outline-4">
<h4 id="org0464117"><span class="section-number-4">1.2.3</span> Plot weather of clear days and cloudy days</h4>
<div class="outline-text-4" id="text-1-2-3">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = cloud.indicator, y = weather)) +
    geom_boxplot() +
    theme_bw(base_size = 18) +
    theme(legend.position = <span style="color: #CC9393;">'bottom'</span>)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-weather-cloud.png" alt="fig-weather-cloud.png" />
</p>
</div>

<p>
There doesn't seem to be a difference between the weather of cloudy days and weather of clear days.
</p>
</div>
</div>
</div>

<div id="outline-container-org453cb3f" class="outline-3">
<h3 id="org453cb3f"><span class="section-number-3">1.3</span> Single-year data analysis</h3>
<div class="outline-text-3" id="text-1-3">
<p>
It is hard to visualize other patterns in the data since the data has <code>2373</code> data points (6.5 years). Therefore, let's plot the data year by year.
</p>
</div>

<div id="outline-container-org1324281" class="outline-4">
<h4 id="org1324281"><span class="section-number-4">1.3.1</span> Year 2010</h4>
<div class="outline-text-4" id="text-1-3-1">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    filter(date &lt; <span style="color: #CC9393;">'2011-01-01'</span>) <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = date, y = car.count,
               color = cloud.indicator)) +
    geom_path() +
    theme_bw(base_size = 18) +
    theme(legend.position = <span style="color: #CC9393;">'bottom'</span>)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-year-2010.png" alt="fig-year-2010.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org89128a4" class="outline-4">
<h4 id="org89128a4"><span class="section-number-4">1.3.2</span> Year 2014</h4>
<div class="outline-text-4" id="text-1-3-2">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    filter(date &lt; <span style="color: #CC9393;">'2015-01-01'</span> &amp; date &gt;= <span style="color: #CC9393;">'2014-01-01'</span>) <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = date, y = car.count,
               color = cloud.indicator)) +
    geom_path() +
    theme_bw(base_size = 18) +
    theme(legend.position = <span style="color: #CC9393;">'bottom'</span>)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-year-2014.png" alt="fig-year-2014.png" />
</p>
</div>

<ul class="org-ul">
<li>Impressions:
<ul class="org-ul">
<li>It is unclear if cyclic behavior exists within a year.</li>
<li>The increasing trend of year 2010 and the decreasing trend of year 2015 may be due to the cyclic behavior across years.</li>
</ul></li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org9be97b4" class="outline-3">
<h3 id="org9be97b4"><span class="section-number-3">1.4</span> Group data points</h3>
<div class="outline-text-3" id="text-1-4">
<p>
Grouping the data points into categories and taking the mean. 
</p>
</div>

<div id="outline-container-orgf75df38" class="outline-4">
<h4 id="orgf75df38"><span class="section-number-4">1.4.1</span> Group by day of week</h4>
<div class="outline-text-4" id="text-1-4-1">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = day.of.week, y = car.count)) +
    geom_boxplot()
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-day-of-week.png" alt="fig-day-of-week.png" />
</p>
</div>

<p>
Not surprisingly, more cars were on the parking lot on Fridays, Saturdays, and Sundays.
</p>
</div>
</div>

<div id="outline-container-org965227f" class="outline-4">
<h4 id="org965227f"><span class="section-number-4">1.4.2</span> Group by day of month</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    filter(cloud.indicator == <span style="color: #CC9393;">'clear'</span>) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(day.of.month = mday(date)) <span style="color: #BFEBBF;">%&gt;%</span>
    group_by(day.of.month) <span style="color: #BFEBBF;">%&gt;%</span>
    summarize(day.of.month.mean = mean(car.count)) <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = day.of.month, y = day.of.month.mean)) +
    ggtitle(<span style="color: #CC9393;">'Group by day of month'</span>) +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_path()
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-day-of-month.png" alt="fig-day-of-month.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org93a6a5b" class="outline-4">
<h4 id="org93a6a5b"><span class="section-number-4">1.4.3</span> Group by day of year</h4>
<div class="outline-text-4" id="text-1-4-3">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    filter(cloud.indicator == <span style="color: #CC9393;">'clear'</span>) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(day.of.year = yday(date)) <span style="color: #BFEBBF;">%&gt;%</span>
    group_by(day.of.year) <span style="color: #BFEBBF;">%&gt;%</span>
    summarize(day.of.year.mean = mean(car.count)) <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = day.of.year, y = day.of.year.mean)) +
    ggtitle(<span style="color: #CC9393;">'Group by day of year'</span>) +
    theme(plot.title = element_text(hjust = 0.5)) +
    geom_path()
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-by-day.png" alt="fig-by-day.png" />
</p>
</div>

<p>
Cyclical behavior (~100 days period) may exist in the <code>Group by day of year</code> plot.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org8657f26" class="outline-2">
<h2 id="org8657f26"><span class="section-number-2">2</span> Analysis in Frequency Domain</h2>
<div class="outline-text-2" id="text-2">
<p>
To identify the dominant cyclical behavior in a series, we will do a spectrum analysis. From now on, I will drop the data of cloudy days and impute the missing values since the data collected from cloudy days are very noisy and seems from a different distribution.
</p>
</div>

<div id="outline-container-org0eec7d3" class="outline-3">
<h3 id="org0eec7d3"><span class="section-number-3">2.1</span> Imputation</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-R">dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(car.count.impute = car.count) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(car.count.impute = replace(car.count,
                                      cloud.indicator == <span style="color: #CC9393;">'cloudy'</span>,
                                      <span style="color: #7CB8BB;">NA</span>)) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(car.count.impute = na.interpolation(car.count,
                                               option = <span style="color: #CC9393;">'spline'</span>))<span style="color: #BFEBBF;">%&gt;%</span>
    select(car.count) <span style="color: #BFEBBF;">%&gt;%</span>
    ts <span style="color: #BFEBBF;">%&gt;%</span>
    plot

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">drop the rows corresponding the the cloudy days</span>
dat_clear <span style="color: #BFEBBF;">&lt;-</span> dat1 <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(car.count.impute = car.count) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(car.count.impute = replace(car.count,
                                      cloud.indicator == <span style="color: #CC9393;">'cloudy'</span>,
                                      <span style="color: #7CB8BB;">NA</span>)) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(month = month(date)) <span style="color: #BFEBBF;">%&gt;%</span>
    mutate(year = year(date))

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">calculate the mean of that month for Monday to Sunday</span>
dat_avg <span style="color: #BFEBBF;">&lt;-</span> dat_clear <span style="color: #BFEBBF;">%&gt;%</span>
    group_by( year, month, day.of.week) <span style="color: #BFEBBF;">%&gt;%</span>
    summarize(avg = mean(car.count.impute, na.rm = T))

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">there are still some NA's after the step above. Replace the NA's</span>
<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">by the average of that year</span>

dat_avg_year <span style="color: #BFEBBF;">&lt;-</span> dat_clear <span style="color: #BFEBBF;">%&gt;%</span>
    group_by( year, day.of.week) <span style="color: #BFEBBF;">%&gt;%</span>
    summarize(avg.year = mean(car.count.impute, na.rm = T))


<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">merge the two date frames above and replace the NA values by the means</span>

dat_impute <span style="color: #BFEBBF;">&lt;-</span> left_join(dat_clear, dat_avg, by = c(<span style="color: #CC9393;">'year'</span>, <span style="color: #CC9393;">'month'</span>, <span style="color: #CC9393;">'day.of.week</span><span style="color: #DC8CC3; background-color: #3F3F3F;">'</span><span style="color: #DC8CC3; background-color: #3F3F3F;">))</span>
dat_impute <span style="color: #BFEBBF;">&lt;-</span> left_join(dat_impute, dat_avg_year, by = c(<span style="color: #CC9393;">'year'</span>, <span style="color: #CC9393;">'day.of.week'</span>))
    
ind_na <span style="color: #BFEBBF;">&lt;-</span> is.na(dat_impute$car.count.impute)
dat_impute$car.count.impute[ind_na] <span style="color: #BFEBBF;">&lt;-</span> dat_impute$avg[ind_na]

ind_na_2 <span style="color: #BFEBBF;">&lt;-</span> is.na(dat_impute$car.count.impute)
dat_impute$car.count.impute[ind_na_2] <span style="color: #BFEBBF;">&lt;-</span> dat_impute$avg.year[ind_na_2]
</pre>
</div>
</div>
</div>

<div id="outline-container-org41d23ec" class="outline-3">
<h3 id="org41d23ec"><span class="section-number-3">2.2</span> Plot the time series with imputed data points</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-R">dat_impute <span style="color: #BFEBBF;">%&gt;%</span>
    ggplot(aes(x = date, y = car.count.impute)) +               
    geom_path() +
    theme_bw(base_size = 18) +
    theme(legend.position = <span style="color: #CC9393;">'bottom'</span>)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-interp.png" alt="fig-interp.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org50709bf" class="outline-3">
<h3 id="org50709bf"><span class="section-number-3">2.3</span> Decompose the series</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-R">dat_impute$car.count.impute <span style="color: #BFEBBF;">%&gt;%</span>
    ts(frequency = 365, start = 2010) <span style="color: #BFEBBF;">%&gt;%</span>
    decompose(<span style="color: #CC9393;">'additive'</span>) <span style="color: #BFEBBF;">%&gt;%</span>
    plot
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-decompose.png" alt="fig-decompose.png" />
</p>
</div>

<p>
Looking at this figure, the trend is clear, and there may exist a three-month periodicity.  
</p>
</div>
</div>
<div id="outline-container-orgf32e48f" class="outline-3">
<h3 id="orgf32e48f"><span class="section-number-3">2.4</span> Spectrum analysis</h3>
<div class="outline-text-3" id="text-2-4">
</div><div id="outline-container-orgb7d0023" class="outline-4">
<h4 id="orgb7d0023"><span class="section-number-4">2.4.1</span> Detrend</h4>
<div class="outline-text-4" id="text-2-4-1">
<p>
Since a clear trend exists for the time series, I chose to detrend with linear regression.
</p>
<div class="org-src-container">
<pre class="src src-R">car_ts <span style="color: #BFEBBF;">&lt;-</span> dat_impute <span style="color: #BFEBBF;">%&gt;%</span>
    select(car.count.impute) <span style="color: #BFEBBF;">%&gt;%</span>
    ts(frequency = 365, start = 2010)

trend <span style="color: #BFEBBF;">&lt;-</span> time(car_ts) - mean(time(car_ts))
trend2 <span style="color: #BFEBBF;">&lt;-</span> trend^2
trend3 <span style="color: #BFEBBF;">&lt;-</span> trend^3
regtrend <span style="color: #BFEBBF;">&lt;-</span> lm(car_ts ~ trend + trend2 + trend3)
summary(regtrend)

plot(as.numeric(trend),
     as.numeric(car_ts),
     xlab = <span style="color: #CC9393;">"Time"</span>,
     ylab = <span style="color: #CC9393;">"Car Count"</span>)
lines(as.numeric(trend),
      as.numeric(predict(regtrend)),
      type = <span style="color: #CC9393;">"l"</span>,col = <span style="color: #CC9393;">'red'</span>, lwd = 2)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-detrend.png" alt="fig-detrend.png" />
</p>
</div>
</div>
</div>
<div id="outline-container-org774262e" class="outline-4">
<h4 id="org774262e"><span class="section-number-4">2.4.2</span> Spectrum Analysis</h4>
<div class="outline-text-4" id="text-2-4-2">
<div class="org-src-container">
<pre class="src src-R">car_spec <span style="color: #BFEBBF;">&lt;-</span> spec.pgram(residuals(regtrend), 
                       spans=c(15,15),
                       taper=0,
                       log =<span style="color: #CC9393;">'no'</span>)


<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">decom_car_ts &lt;- decompose(car_ts,type='additive')</span>

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">acf2(decom_car_ts$random, na.action = na.pass)</span>

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">samp_size = length(decom_car_ts$seasonal)</span>
<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">FF = abs(fft(decom_car_ts$seasonal)/sqrt(samp_size))^2</span>
<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">P = (4/samp_size)*FF[1:(samp_size%/%2)]</span>
<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">f = (0:(samp_size%/%2-1))/samp_size</span>
<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">plot(f,P,type="l")</span>

<span style="color: #5F7F5F;">## </span><span style="color: #7F9F7F;">1/f[which.max(P)]</span>
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-spec.png" alt="fig-spec.png" />
</p>
</div>

<p>
The first peak in the figure above corresponds to a seasonal pattern for <code>92</code> days, approximately 3 months. The second peak corresponds to a seasonal pattern for <code>7</code> days, a week. Although this 7-day periodicity is unsurprising, we need to keep in mind that the second peak may be a consequence of the data imputation. 
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org494cdad" class="outline-2">
<h2 id="org494cdad"><span class="section-number-2">3</span> Fit ARIMA models</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-orgb36e426" class="outline-3">
<h3 id="orgb36e426"><span class="section-number-3">3.1</span> ARIMA \((1,0,1)×(0,1,0)_{92}\)</h3>
<div class="outline-text-3" id="text-3-1">
<p>
My first try is \(ARIMA(1,0,1)×(0,1,0)_{92}\).
</p>
<ul class="org-ul">
<li>Fit the model</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">sarima(car_ts, p = 1, d = 0, q = 1,
       P = 0, Q = 1, D = 0,S = 92,
       xreg=cbind(trend,trend2, trend3))
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-sarima-examp.png" alt="fig-sarima-examp.png" />
</p>
</div>

<p>
Here, the ACF of residuals shows that autocorrelation still exists for the residuals. The normal Q-Q plot indicates deviations at the tails. Further, Ljung-Box statistic is significant for most of the lags. Clearly, this model does not fit the data well, and more models need to be compared. 
</p>

<ul class="org-ul">
<li>Make predications</li>
</ul>
<p>
For illustration purpose, I will use this model to make some predications.
</p>
<div class="org-src-container">
<pre class="src src-R">sarima.for(car_ts, n.ahead = 10,
           p = 1, d = 0, q = 1,
           P = 0, Q = 1, D=0,S=91)
</pre>
</div>


<div class="figure">
<p><img src="http://math.arizona.edu/~qikeli/Figs/Orbitial-insight/fig-sarima-pred.png" alt="fig-sarima-pred.png" />
</p>
</div>
</div>
</div>

<div id="outline-container-org13239d4" class="outline-3">
<h3 id="org13239d4"><span class="section-number-3">3.2</span> Choose ARIMA models</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>We could use AIC or BIC to choose between ARIMA models. For the sake of computation simplification, let's choose the orders for AR and MA first and then the orders for SAR and SMA. Note, here we set S = 92.</li>
</ul>
<div class="org-src-container">
<pre class="src src-R"><span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Calculate the number of cores</span>
no_cores <span style="color: #BFEBBF;">&lt;-</span> detectCores() - 1
 
<span style="color: #5F7F5F;"># </span><span style="color: #7F9F7F;">Initiate cluster</span>
cl <span style="color: #BFEBBF;">&lt;-</span> makeCluster(no_cores)
par_m <span style="color: #BFEBBF;">&lt;-</span> expand.grid(1:5,1:5)
colnames(par_m) <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">'AR'</span>, <span style="color: #CC9393;">'MA'</span>)
clusterExport(cl, c(<span style="color: #CC9393;">'Arima'</span>,<span style="color: #CC9393;">'car_ts'</span>, <span style="color: #CC9393;">'par_m'</span>))

t  <span style="color: #BFEBBF;">&lt;-</span> Sys.time()
bic_all <span style="color: #BFEBBF;">&lt;-</span> clusterMap(cl, <span style="color: #F0DFAF; font-weight: bold;">function</span>(p,q)
    Arima(car_ts,
          order = c(p,0,q),
          seasonal = list(order = c(0,1,0),
                          period = 92))$bic,
           p = par_m$AR, q = par_m$MA, SIMPLIFY = T)
Sys.time() - t

model_bic <span style="color: #BFEBBF;">&lt;-</span> data.frame(AR = stringr::str_c(names(par_m)[1],par_m[,1]),
                        MA = stringr::str_c(names(par_m)[2],par_m[,2]),
                        BIC = bic_all)
</pre>
</div>

<ul class="org-ul">
<li>The data frame <code>model_bic</code> in the above code block contains the BIC's for models with different orders of AR and MA. We can find the the smallest BIC and its corresponding AR (<code>p</code>) order and MA order (<code>q</code>).</li>

<li>Using the <code>p</code> and <code>q</code> form the previous step, we can then find the optimal SAR (<code>P</code>) order and SMA order (<code>Q</code>) as follows.</li>
</ul>
<div class="org-src-container">
<pre class="src src-R">cl <span style="color: #BFEBBF;">&lt;-</span> makeCluster(no_cores)
par_m_s <span style="color: #BFEBBF;">&lt;-</span> expand.grid(1:5,1:5)
colnames(par_m_s) <span style="color: #BFEBBF;">&lt;-</span> c(<span style="color: #CC9393;">'SAR'</span>, <span style="color: #CC9393;">'SMA'</span>)
clusterExport(cl, c(<span style="color: #CC9393;">'Arima'</span>,<span style="color: #CC9393;">'car_ts'</span>, <span style="color: #CC9393;">'par_m_s'</span>))

t  <span style="color: #BFEBBF;">&lt;-</span> Sys.time()
bic_all_s <span style="color: #BFEBBF;">&lt;-</span> clusterMap(cl, <span style="color: #F0DFAF; font-weight: bold;">function</span>(P,Q)
    Arima(car_ts,
          order = c(5,0,4),
          seasonal = list(order = c(P,1,Q),
                          period = 92))$bic,
           p = par_m_s$SAR, q = par_m_s$SMA, SIMPLIFY = T)
Sys.time() - t

model_bic_s <span style="color: #BFEBBF;">&lt;-</span> data.frame(AR = stringr::str_c(names(par_m)[1],par_m[,1]),
                        MA = stringr::str_c(names(par_m)[2],par_m[,2]),
                        BIC = bic_all)
</pre>
</div>

<p>
With this process, we can find the top models that yield the lowest BIC. Further, we need to do necessary model diagnostics and pick the best model. Note, even I parallelized the computation, this process is still time consuming and therefore not conducted. 
</p>
</div>
</div>
</div>
<div id="outline-container-org700031d" class="outline-2">
<h2 id="org700031d"><span class="section-number-2">4</span> Future analysis</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>If I had a whole day to work on this problem, I would explore the following things:
<ul class="org-ul">
<li>Missing data. For now, I am averaging over a month, but I could try averaging over three months or over a year. Alternatively I could do interpolation. However, as I alluded to in <b>Section 2.4.2</b>, data imputation may introduce bias. To avoid that, I could explore techniques that don't require evenly spaced time series. For example, I could use Lomb-Scargle periodogram for unevenly sampled time series.</li>

<li>Incorporate data of cloudy days. For simplicity, I dropped the data of cloudy days in this analysis. However, incorporating them may improve our model. The model for the series of cloudy days and the model for series of clear days should share many similarities, except that the error terms in the model for cloudy days should have larger variances.</li>

<li>Do a grid search for the parameters and identify the best ARIMA model based on AIC/BIC and model diagnostics.</li>

<li>Determine how weather affects car counts.</li>

<li>The 3-month periodicity is an interesting feature of this dataset. Understanding the reason of this pattern will be helpful for interpreting the model and for identifying potential useful features for future predicative models.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: &lt;2017-12-4 Mon 20:00&gt;</p>
<p class="author">Author: Qike Max Li</p>
<p class="date">Created: 2017-12-20 Wed 18:28</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
