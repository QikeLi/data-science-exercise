<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-07-31 Tue 09:16 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DoorDash Data Science Project</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Qike Max Li" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.js"></script>
<script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">DoorDash Data Science Project</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf167b26">1. A few thoughts</a>
<ul>
<li><a href="#org97355bf">1.1. Overview</a>
<ul>
<li><a href="#org2bacad5">1.1.1. Objectives</a></li>
<li><a href="#orgccfe2d7">1.1.2. Datasets</a></li>
<li><a href="#org90c4b9a">1.1.3. My approach</a></li>
</ul>
</li>
<li><a href="#org58316ab">1.2. Challenges</a>
<ul>
<li><a href="#org24419e1">1.2.1. Missing values</a></li>
<li><a href="#org64e9b96">1.2.2. Feature engineering</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3512799">2. EDA</a>
<ul>
<li><a href="#orga6fe3a2">2.1. Add some features</a>
<ul>
<li><a href="#orgcd79a7c">2.1.1. Extract day of week and hour of day</a></li>
<li><a href="#org8cfc7d7">2.1.2. Investigate the average market features for each day of a week and each hour of a day</a></li>
<li><a href="#org3f64a98">2.1.3. Hour of day</a></li>
</ul>
</li>
<li><a href="#org61c9cef">2.2. Missing values</a>
<ul>
<li><a href="#orgc5a5687">2.2.1. Count the number of missing values for each column</a></li>
<li><a href="#orgd3bc4ae">2.2.2. Impute the missing values for some columns</a></li>
<li><a href="#org8391542">2.2.3. Treat the <code>NaN</code> as an extra level of the categorical variable</a></li>
<li><a href="#orgeaf1fc5">2.2.4. Remove some data points</a></li>
</ul>
</li>
<li><a href="#org74b6887">2.3. Compute the duration from orders created to orders delivered</a></li>
</ul>
</li>
<li><a href="#org1f05934">3. Training</a>
<ul>
<li><a href="#orgeea7422">3.1. Automatic Machine Learnig (AutoML)</a></li>
<li><a href="#orga65264a">3.2. Mixed effects model</a></li>
</ul>
</li>
<li><a href="#orgb4588a4">4. Prediction</a>
<ul>
<li><a href="#org243e78c">4.1. Script for model serving</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgf167b26" class="outline-2">
<h2 id="orgf167b26"><span class="section-number-2">1</span> A few thoughts</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org97355bf" class="outline-3">
<h3 id="org97355bf"><span class="section-number-3">1.1</span> Overview</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-org2bacad5" class="outline-4">
<h4 id="org2bacad5"><span class="section-number-4">1.1.1</span> Objectives</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Given a few categorical and numerical variables, predict the delivery time.
</p>
</div>
</div>
<div id="outline-container-orgccfe2d7" class="outline-4">
<h4 id="orgccfe2d7"><span class="section-number-4">1.1.2</span> Datasets</h4>
<div class="outline-text-4" id="text-1-1-2">
<ul class="org-ul">
<li>historical data</li>
<li>test data</li>
</ul>
</div>
</div>
<div id="outline-container-org90c4b9a" class="outline-4">
<h4 id="org90c4b9a"><span class="section-number-4">1.1.3</span> My approach</h4>
<div class="outline-text-4" id="text-1-1-3">
<p>
Due to time constraints, in this exercise, I don't strive for the best performing model but rather to demonstrate how I approach a data science problem. In other words, no attempts were made in carefully tuning the models. Heavy model tuning often lead to only incremental increase of model accuracy. Whereas, substantial accuracy gain are often resulted from better understanding of the problem, identifying the right features to collect, and designing models to represent the special structure/characteristics in data.  
</p>
</div>
</div>
</div>
<div id="outline-container-org58316ab" class="outline-3">
<h3 id="org58316ab"><span class="section-number-3">1.2</span> Challenges</h3>
<div class="outline-text-3" id="text-1-2">
</div>
<div id="outline-container-org24419e1" class="outline-4">
<h4 id="org24419e1"><span class="section-number-4">1.2.1</span> Missing values</h4>
<div class="outline-text-4" id="text-1-2-1">
<p>
In the historical dataset, some variables have missing values. Note, throughout this report I use variables and features interchangeably. 
</p>
</div>
<ol class="org-ol">
<li><a id="orgb26b90e"></a><code>total_onshift_dashers</code>, <code>total_busy_dashers</code>, and <code>total_outstanding_orders</code><br />
<div class="outline-text-5" id="text-1-2-1-1">
<p>
These variables represent market features. Since the market feature of the same time, i.e. the same hour of the same day of week, should be reasonably consistent. To impute the missing values, I took the average of these variables from the same time.
</p>
</div>
</li>
<li><a id="org658233b"></a><code>estimated_store_to_consumer_driving_duration</code><br />
<div class="outline-text-5" id="text-1-2-1-2">
<p>
This is the estimated travel time between store and consumer. Stores located at areas with heavy traffic may tend to have longer driving duration time, and vice versa. Therefore, I used the average of driving duration time of a store to fill in the missing driving duration times of the same store. Note, this may not be a good strategy to fill in the missing values since the driving time should also depend on the distance from a customer to a store. To determine the approach of engineering this feature, model performances should be compared between with and without imputing this variable.
</p>
</div>
</li>
<li><a id="org63a65bc"></a><code>store_primary_category</code><br />
<div class="outline-text-5" id="text-1-2-1-3">
<p>
A store often offers one type of cuisine. Therefore, for each store, I take its most frequent category to fill in the missing values.
</p>
</div>
</li>
<li><a id="org3084d7b"></a><code>market_id</code> and <code>order_protocol</code><br />
<div class="outline-text-5" id="text-1-2-1-4">
<p>
Instead of imputing the missing values for these two variables, I chose to treat the missing values as an extra level of the categorical variables since the their possible values cannot be inferred from the other variables. 
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org64e9b96" class="outline-4">
<h4 id="org64e9b96"><span class="section-number-4">1.2.2</span> Feature engineering</h4>
<div class="outline-text-4" id="text-1-2-2">
</div>
<ol class="org-ol">
<li><a id="org49c7217"></a>The cyclic nature of the feature <code>hour</code><br />
<div class="outline-text-5" id="text-1-2-2-1">
<p>
Hour of day is an ordinal cyclic variables. It is inappropriate to treat this variable as numeric or ordinal.
</p>

<p>
Delivery time heavily depends on the hour of day, and <code>hour</code> should definitely be included as a feature. It is not ideal to treat hour as a numerical variable since delivery time at 1am should be similar to that at midnight (hour=24). If we treat <code>hour</code> as a numerical variable, we implicitly assume the delivery time at 1am should be much similar to the delivery time at 2am than to the delivery time at midnight.
To take care of cyclicity, I did the following trigonometric transformation
</p>

\begin{eqnarray*}
x &=& \sin(2\pi\cdot hour/24)\\
y &=& \cos(2\pi\cdot hour/24)
\end{eqnarray*}

<p>
After the transformation, the distance between 1am and 24:00 and the distance between 1am and 2am are the same. Hence, I replaced the variable <code>hour</code> by <code>x-hour</code> and <code>y-hour</code>.  Note, even with deep learning, which doesn't require intensive feature engineering, these features are not likely to automatically emerge.
</p>


<div class="figure">
<p><img src="./Figures/fig-hour.png" alt="fig-hour.png" />
</p>
</div>
</div>
</li>

<li><a id="org93d93c7"></a>Linear vs non-linear; additive vs. interactive<br />
<div class="outline-text-5" id="text-1-2-2-2">
<p>
Linear assumption is inappropriate since the delivery time never linearly increase as the other variables (e.g. <code>week of day</code>) increase.
</p>

<p>
The additive assumption is also inappropriate since interactive effects, such as <code>week of day</code> and <code>hour</code>, clearly exist. 
</p>
</div>
</li>

<li><a id="org8005c61"></a>Random effects<br />
<div class="outline-text-5" id="text-1-2-2-3">
<p>
Random effects models — also known as hierarchical models — allow us to ascribe distinct behaviors to different "clusters" of observations, e.g. markets (<code>market_id</code>) may each act in a unique way. Furthermore, these models allow us to infer these tendencies in a collaborative fashion: while each market/cluster is assumed to behave differently, their parameters can be learned by heeding to the behavior of the population at large.
</p>

<p>
Linear mixed effects model is a widely used model to incorporate the random effects. However, since this model is a linear model, we need to manually engineer the features to incorporate the non-linearity and interactions between features.  
</p>

<p>
Neural networks are powerful function approximators and seem particularly suitable in this case to avoid the explicit feature engineering. Therefore, I also explored random effects models with deep neural network basis functions. 
</p>

<p>
To my knowledge, there are no available algorithms to model the random effects while approximating basis functions by neural networks. Fortunately, Bayesian probabilistic models provide a nimble and expressive framework. <a href="http://www.edwardlib.org">Edward</a> is a probabilistic programming library that enables easy implementation of Bayesian probabilistic/generative models. Moreover, Edward uses TensorFlow as backend and variational inference as the inference tool, which allows the implemented algorithms to scale to massive data. Given the time constraints, my initial attempt is only exploratory, and I didn't end up using this model for model serving.
</p>
</div>
</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org3512799" class="outline-2">
<h2 id="org3512799"><span class="section-number-2">2</span> EDA</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orga6fe3a2" class="outline-3">
<h3 id="orga6fe3a2"><span class="section-number-3">2.1</span> Add some features</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The delivery time may depend on which day of week and which hour of day. Therefore, I extracted week of day and hour of day from the variable <code>created_at</code>
</p>
</div>

<div id="outline-container-orgcd79a7c" class="outline-4">
<h4 id="orgcd79a7c"><span class="section-number-4">2.1.1</span> Extract day of week and hour of day</h4>
<div class="outline-text-4" id="text-2-1-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> math
<span style="color: #4f97d7; font-weight: bold;">from</span> datetime <span style="color: #4f97d7; font-weight: bold;">import</span> datetime

<span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt
<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">import</span> pandas <span style="color: #4f97d7; font-weight: bold;">as</span> pd

%matplotlib inline
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">Train</span> = pd.read_csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'../../Data Science/historical_data.csv'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Train.actual_delivery_time</span> = \
    pd.to_datetime<span style="color: #4f97d7;">(</span>Train.actual_delivery_time<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Train.created_at</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>Train.created_at<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Train</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'weekday'</span><span style="color: #4f97d7;">]</span> = Train.created_at.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x.weekday<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Train</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'hour'</span><span style="color: #4f97d7;">]</span> = Train.created_at.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x.hour<span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8cfc7d7" class="outline-4">
<h4 id="org8cfc7d7"><span class="section-number-4">2.1.2</span> Investigate the average market features for each day of a week and each hour of a day</h4>
<div class="outline-text-4" id="text-2-1-2">
</div>
<ol class="org-ol">
<li><a id="org5a02282"></a>Market feature vary substantially from day to day<br />
<div class="outline-text-5" id="text-2-1-2-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">grouped_mean_day</span> = Train.groupby<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'weekday'</span><span style="color: #4f97d7;">)</span>.agg<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'total_onshift_dashers'</span>:
    np.<span style="color: #4f97d7;">sum</span>,
    <span style="color: #2d9574;">'total_busy_dashers'</span>:
    np.<span style="color: #4f97d7;">sum</span>,
    <span style="color: #2d9574;">'total_outstanding_orders'</span>:
    np.<span style="color: #4f97d7;">sum</span>
<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">create plot</span>
<span style="color: #7590db;">fig</span>, <span style="color: #7590db;">ax</span> = plt.subplots<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">index</span> = grouped_mean_day.index.values
<span style="color: #7590db;">bar_width</span> = <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">25</span>
<span style="color: #7590db;">opacity</span> = <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">8</span>

<span style="color: #7590db;">rects1</span> = plt.bar<span style="color: #4f97d7;">(</span>
    index,
    grouped_mean_day.total_busy_dashers,
    bar_width,
    alpha=opacity,
    color=<span style="color: #2d9574;">'b'</span>,
    label=<span style="color: #2d9574;">'# busy_dashers'</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">rects2</span> = plt.bar<span style="color: #4f97d7;">(</span>
    index + bar_width,
    grouped_mean_day.total_onshift_dashers,
    bar_width,
    alpha=opacity,
    color=<span style="color: #2d9574;">'g'</span>,
    label=<span style="color: #2d9574;">'# onshift_dashers'</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">rects3</span> = plt.bar<span style="color: #4f97d7;">(</span>
    index + <span style="color: #a45bad;">2</span> * bar_width,
    grouped_mean_day.total_outstanding_orders,
    bar_width,
    alpha=opacity,
    color=<span style="color: #2d9574;">'r'</span>,
    label=<span style="color: #2d9574;">'# outstanding_orders'</span><span style="color: #4f97d7;">)</span>

plt.xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Day of Week'</span><span style="color: #4f97d7;">)</span>
plt.ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Market Features'</span><span style="color: #4f97d7;">)</span>
plt.title<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Market Features by day'</span><span style="color: #4f97d7;">)</span>
plt.xticks<span style="color: #4f97d7;">(</span>index + bar_width,
           <span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">'Mon'</span>, <span style="color: #2d9574;">'Tue'</span>, <span style="color: #2d9574;">'Wed'</span>, <span style="color: #2d9574;">'Thur'</span>, <span style="color: #2d9574;">'Fri'</span>, <span style="color: #2d9574;">'Sat'</span>, <span style="color: #2d9574;">'Sun'</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
plt.legend<span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
&lt;matplotlib.legend.Legend at 0x1105cc350&gt;

</pre>

<div class="figure">
<p><img src="./obipy-resources/57942XTf.png" alt="57942XTf.png" />
</p>
</div>
</div>
</li>

<li><a id="orgf40c54e"></a>Market feature vary substantially from hour to hour<br />
<div class="outline-text-5" id="text-2-1-2-2">
<p>
Here I only show two days. The same pattern holds for the other days. 
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">grouped_mean</span> = Train.groupby<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'weekday'</span>, <span style="color: #2d9574;">'hour'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>.agg<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'total_onshift_dashers'</span>:
    np.<span style="color: #4f97d7;">sum</span>,
    <span style="color: #2d9574;">'total_busy_dashers'</span>:
    np.<span style="color: #4f97d7;">sum</span>,
    <span style="color: #2d9574;">'total_outstanding_orders'</span>:
    np.<span style="color: #4f97d7;">sum</span>
<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>


<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">define a function to make a plot for the market features of each hour</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">create plot</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">f_plot</span><span style="color: #4f97d7;">(</span>which_day=<span style="color: #a45bad;">0</span>, day=<span style="color: #2d9574;">'Monday'</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">fig</span>, <span style="color: #7590db;">ax</span> = plt.subplots<span style="color: #4f97d7;">()</span>
    <span style="color: #7590db;">index</span> = np.arange<span style="color: #4f97d7;">(</span>grouped_mean.loc<span style="color: #bc6ec5;">[</span>which_day<span style="color: #bc6ec5;">]</span>.shape<span style="color: #bc6ec5;">[</span><span style="color: #a45bad;">0</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">bar_width</span> = .<span style="color: #a45bad;">25</span>
    <span style="color: #7590db;">opacity</span> = <span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">8</span>

    <span style="color: #7590db;">rects1</span> = plt.bar<span style="color: #4f97d7;">(</span>
        index,
        grouped_mean.loc<span style="color: #bc6ec5;">[</span>which_day<span style="color: #bc6ec5;">]</span>.total_busy_dashers,
        bar_width,
        alpha=opacity,
        color=<span style="color: #2d9574;">'b'</span>,
        label=<span style="color: #2d9574;">'# busy_dashers'</span><span style="color: #4f97d7;">)</span>

    <span style="color: #7590db;">rects2</span> = plt.bar<span style="color: #4f97d7;">(</span>
        index + bar_width,
        grouped_mean.loc<span style="color: #bc6ec5;">[</span>which_day<span style="color: #bc6ec5;">]</span>.total_onshift_dashers,
        bar_width,
        alpha=opacity,
        color=<span style="color: #2d9574;">'g'</span>,
        label=<span style="color: #2d9574;">'# onshift_dashers'</span><span style="color: #4f97d7;">)</span>

    <span style="color: #7590db;">rects3</span> = plt.bar<span style="color: #4f97d7;">(</span>
        index + <span style="color: #a45bad;">2</span> * bar_width,
        grouped_mean.loc<span style="color: #bc6ec5;">[</span>which_day<span style="color: #bc6ec5;">]</span>.total_outstanding_orders,
        bar_width,
        alpha=opacity,
        color=<span style="color: #2d9574;">'r'</span>,
        label=<span style="color: #2d9574;">'# outstanding_orders'</span><span style="color: #4f97d7;">)</span>

    plt.xlabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Day of Week'</span><span style="color: #4f97d7;">)</span>
    plt.ylabel<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Market Features'</span><span style="color: #4f97d7;">)</span>
    plt.title<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Market Features by hour on '</span> + day<span style="color: #4f97d7;">)</span>
    plt.xticks<span style="color: #4f97d7;">(</span>index + bar_width, grouped_mean.loc<span style="color: #bc6ec5;">[</span>which_day<span style="color: #bc6ec5;">]</span>.index.values<span style="color: #4f97d7;">)</span>
    plt.legend<span style="color: #4f97d7;">()</span>


f_plot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">1</span>, <span style="color: #2d9574;">'Monday'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/57942kdl.png" alt="57942kdl.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython">f_plot<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">6</span>, <span style="color: #2d9574;">'Saturday'</span><span style="color: #4f97d7;">)</span>
</pre>
</div>


<div class="figure">
<p><img src="./obipy-resources/57942xnr.png" alt="57942xnr.png" />
</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org3f64a98" class="outline-4">
<h4 id="org3f64a98"><span class="section-number-4">2.1.3</span> Hour of day</h4>
<div class="outline-text-4" id="text-2-1-3">
<p>
Hour of day is an ordinal cyclic variables. It is inappropriate to treat this variable as numeric or ordinal. We need to take care of cyclicity. Thus we do the following trigonometric transformation
</p>

\begin{eqnarray*}
x &=& \sin(2\pi\cdot hour/24)\\
y &=& \cos(2\pi\cdot hour/24)
\end{eqnarray*}

<p>
After the transformation, the distance between 1am and 24:00 and the distance between 1am and 2am are the same. Hence, we replace the variable <code>hour</code> by <code>x-hour</code> and <code>y-hour</code>. 
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">hour_x</span><span style="color: #4f97d7;">(</span>hour<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> math.sin<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span> * math.pi * hour / <span style="color: #a45bad;">24</span><span style="color: #4f97d7;">)</span>


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">hour_y</span><span style="color: #4f97d7;">(</span>hour<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> math.cos<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span> * math.pi * hour / <span style="color: #a45bad;">24</span><span style="color: #4f97d7;">)</span>


<span style="color: #7590db;">Train</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'hour_x'</span><span style="color: #4f97d7;">]</span> = Train.hour.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span>hour_x<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Train</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'hour_y'</span><span style="color: #4f97d7;">]</span> = Train.hour.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span>hour_y<span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org61c9cef" class="outline-3">
<h3 id="org61c9cef"><span class="section-number-3">2.2</span> Missing values</h3>
<div class="outline-text-3" id="text-2-2">
</div>
<div id="outline-container-orgc5a5687" class="outline-4">
<h4 id="orgc5a5687"><span class="section-number-4">2.2.1</span> Count the number of missing values for each column</h4>
<div class="outline-text-4" id="text-2-2-1">
<div class="org-src-container">
<pre class="src src-ipython">Train.isnull<span style="color: #4f97d7;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">()</span>
</pre>
</div>

<pre class="example">
market_id                                         987
created_at                                          0
actual_delivery_time                                7
store_id                                            0
store_primary_category                           4760
order_protocol                                    995
total_items                                         0
subtotal                                            0
num_distinct_items                                  0
min_item_price                                      0
max_item_price                                      0
total_onshift_dashers                           16262
total_busy_dashers                              16262
total_outstanding_orders                        16262
estimated_order_place_duration                      0
estimated_store_to_consumer_driving_duration      526
weekday                                             0
hour                                                0
hour_x                                              0
hour_y                                              0
dtype: int64
</pre>
</div>
</div>

<div id="outline-container-orgd3bc4ae" class="outline-4">
<h4 id="orgd3bc4ae"><span class="section-number-4">2.2.2</span> Impute the missing values for some columns</h4>
<div class="outline-text-4" id="text-2-2-2">
</div>
<ol class="org-ol">
<li><a id="org70c5c5b"></a>For <code>total_onshift_dashers</code>, <code>total_busy_dashers</code>, and <code>total_outstanding_orders</code>, replace the missing values by the corresponding average from the same hour of day and the same day of week<br />
<div class="outline-text-5" id="text-2-2-2-1">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">cols</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #2d9574;">'total_onshift_dashers'</span>,
    <span style="color: #2d9574;">'total_busy_dashers'</span>,
    <span style="color: #2d9574;">'total_outstanding_orders'</span>
<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">grouped_mean</span> = Train.groupby<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'weekday'</span>, <span style="color: #2d9574;">'hour'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>.agg<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'total_onshift_dashers'</span>:
    np.mean,
    <span style="color: #2d9574;">'total_busy_dashers'</span>:
    np.mean,
    <span style="color: #2d9574;">'total_outstanding_orders'</span>:
    np.mean
<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">Train_merge</span> = Train.reset_index<span style="color: #4f97d7;">()</span>.join<span style="color: #4f97d7;">(</span>
    grouped_mean, on=<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'weekday'</span>, <span style="color: #2d9574;">'hour'</span><span style="color: #bc6ec5;">]</span>, lsuffix=<span style="color: #2d9574;">'_x'</span>, rsuffix=<span style="color: #2d9574;">'_y'</span><span style="color: #4f97d7;">)</span>

Train.loc<span style="color: #4f97d7;">[</span>Train.loc<span style="color: #bc6ec5;">[</span>:,cols<span style="color: #bc6ec5;">]</span>.isnull<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">any</span><span style="color: #bc6ec5;">(</span>axis=<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>.tolist<span style="color: #bc6ec5;">()</span>, cols<span style="color: #4f97d7;">]</span> =\
    Train_merge.loc<span style="color: #4f97d7;">[</span>Train.loc<span style="color: #bc6ec5;">[</span>:, cols<span style="color: #bc6ec5;">]</span>.isnull<span style="color: #bc6ec5;">()</span>.<span style="color: #4f97d7;">any</span><span style="color: #bc6ec5;">(</span>axis=<span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>.tolist<span style="color: #bc6ec5;">()</span>,
                    <span style="color: #bc6ec5;">[</span>c+<span style="color: #2d9574;">'_y'</span> <span style="color: #4f97d7; font-weight: bold;">for</span> c <span style="color: #4f97d7; font-weight: bold;">in</span> cols<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">]</span>.values
</pre>
</div>
</div>
</li>

<li><a id="orgfd9d4ac"></a>For <code>estimated_store_to_consumer_driving_duration</code>, replace the missing values by the average from the same store<br />
<div class="outline-text-5" id="text-2-2-2-2">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">grouped_mean_store</span> = Train.groupby<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'store_id'</span><span style="color: #4f97d7;">)</span>.agg<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">{</span>
    <span style="color: #2d9574;">'estimated_store_to_consumer_driving_duration'</span>:
    np.mean
<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">Train_merge_store</span> = Train.reset_index<span style="color: #4f97d7;">()</span>.join<span style="color: #4f97d7;">(</span>
    grouped_mean_store, on=<span style="color: #2d9574;">'store_id'</span>, lsuffix=<span style="color: #2d9574;">'_x'</span>, rsuffix=<span style="color: #2d9574;">'_y'</span><span style="color: #4f97d7;">)</span>
Train.loc<span style="color: #4f97d7;">[</span>Train.loc<span style="color: #bc6ec5;">[</span>:,<span style="color: #2d9574;">'estimated_store_to_consumer_driving_duration'</span><span style="color: #bc6ec5;">]</span>\
    .isnull<span style="color: #bc6ec5;">()</span>.tolist<span style="color: #bc6ec5;">()</span>, <span style="color: #2d9574;">'estimated_store_to_consumer_driving_duration'</span><span style="color: #4f97d7;">]</span> =\
    Train_merge_store.loc<span style="color: #4f97d7;">[</span>Train.loc<span style="color: #bc6ec5;">[</span>:,
    <span style="color: #2d9574;">'estimated_store_to_consumer_driving_duration'</span><span style="color: #bc6ec5;">]</span>.isnull<span style="color: #bc6ec5;">()</span>.tolist<span style="color: #bc6ec5;">()</span>,
    <span style="color: #2d9574;">'estimated_store_to_consumer_driving_duration'</span>+<span style="color: #2d9574;">'_y'</span><span style="color: #4f97d7;">]</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">remove the only data point that has NaN for</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">estimated_store_to_consumer_driving_duration. Note, this store only has this</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">one record</span>
<span style="color: #7590db;">Train</span> = Train<span style="color: #4f97d7;">[</span>~Train.estimated_store_to_consumer_driving_duration.isnull<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</li>

<li><a id="orgdef6703"></a>Use the majority of the <code>store_primary_category</code> of a store to replace the missing values<br />
<div class="outline-text-5" id="text-2-2-2-3">
<div class="org-src-container">
<pre class="src src-ipython">Train.isnull<span style="color: #4f97d7;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">()</span>

<span style="color: #7590db;">group_maj_categ</span> = Train.groupby<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'store_id'</span><span style="color: #4f97d7;">)</span>.\
            agg<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">{</span><span style="color: #2d9574;">'store_primary_category'</span>:
                <span style="color: #4f97d7; font-weight: bold;">lambda</span> x: np.nan <span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">len</span><span style="color: #2d9574;">(</span>pd.value_counts<span style="color: #67b11d;">(</span>x<span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span> == <span style="color: #a45bad;">0</span>
                <span style="color: #4f97d7; font-weight: bold;">else</span> pd.value_counts<span style="color: #2d9574;">(</span>x<span style="color: #2d9574;">)</span>.idxmax<span style="color: #2d9574;">()</span><span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">Train_merge_store</span> = Train.reset_index<span style="color: #4f97d7;">()</span>.join<span style="color: #4f97d7;">(</span>
    group_maj_categ, on=<span style="color: #2d9574;">'store_id'</span>, lsuffix=<span style="color: #2d9574;">'_x'</span>, rsuffix=<span style="color: #2d9574;">'_y'</span><span style="color: #4f97d7;">)</span>

Train.isnull<span style="color: #4f97d7;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">()</span>
Train_merge_store.isnull<span style="color: #4f97d7;">()</span>.<span style="color: #4f97d7;">sum</span><span style="color: #4f97d7;">()</span>
Train.loc<span style="color: #4f97d7;">[</span>Train.loc<span style="color: #bc6ec5;">[</span>:,<span style="color: #2d9574;">'store_primary_category'</span><span style="color: #bc6ec5;">]</span>\
            .isnull<span style="color: #bc6ec5;">()</span>.tolist<span style="color: #bc6ec5;">()</span>, <span style="color: #2d9574;">'store_primary_category'</span><span style="color: #4f97d7;">]</span> =\
            Train_merge_store.loc<span style="color: #4f97d7;">[</span>Train.loc<span style="color: #bc6ec5;">[</span>:,
            <span style="color: #2d9574;">'store_primary_category'</span><span style="color: #bc6ec5;">]</span>.isnull<span style="color: #bc6ec5;">()</span>.tolist<span style="color: #bc6ec5;">()</span>,
                                  <span style="color: #2d9574;">'store_primary_category_y'</span><span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org8391542" class="outline-4">
<h4 id="org8391542"><span class="section-number-4">2.2.3</span> Treat the <code>NaN</code> as an extra level of the categorical variable</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
For the <code>NaN's</code> in <code>market_id</code> and <code>order_protocol</code>, and the remaining <code>NaN's</code> in <code>store_primary_category_x</code>, I treat them as a special level of these categorical variables 
</p>
</div>
</div>
<div id="outline-container-orgeaf1fc5" class="outline-4">
<h4 id="orgeaf1fc5"><span class="section-number-4">2.2.4</span> Remove some data points</h4>
<div class="outline-text-4" id="text-2-2-4">
</div>
<ol class="org-ol">
<li><a id="orge28018f"></a>remove rows with no delivery time<br />
<div class="outline-text-5" id="text-2-2-4-1">
<p>
Since no label is recorded, nothing can be learned from the data points. I remove those data points.
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">Train</span> = Train<span style="color: #4f97d7;">[</span>~Train.actual_delivery_time.isnull<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">]</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-org74b6887" class="outline-3">
<h3 id="org74b6887"><span class="section-number-3">2.3</span> Compute the duration from orders created to orders delivered</h3>
<div class="outline-text-3" id="text-2-3">
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #7590db;">Train</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'duration'</span><span style="color: #4f97d7;">]</span> = <span style="color: #4f97d7;">(</span>Train<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'actual_delivery_time'</span><span style="color: #bc6ec5;">]</span> - Train<span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'created_at'</span><span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x.seconds<span style="color: #4f97d7;">)</span>
Train.drop<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">'actual_delivery_time'</span>,<span style="color: #2d9574;">'created_at'</span>, <span style="color: #2d9574;">'hour'</span><span style="color: #bc6ec5;">]</span>, axis=<span style="color: #a45bad;">1</span>, inplace=<span style="color: #a45bad;">True</span><span style="color: #4f97d7;">)</span>
Train.to_csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'./data/data.csv'</span>, index=<span style="color: #a45bad;">False</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1f05934" class="outline-2">
<h2 id="org1f05934"><span class="section-number-2">3</span> Training</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgeea7422" class="outline-3">
<h3 id="orgeea7422"><span class="section-number-3">3.1</span> Automatic Machine Learnig (AutoML)</h3>
<div class="outline-text-3" id="text-3-1">
<p>
In recent years a number of AutoML have been developed. <a href="https://h2o-release.s3.amazonaws.com/h2o/master/3888/docs-website/h2o-docs/automl.html">H2O</a> offers an easy-to-use AutoML package. The AutoML tools significantly reduce the effort on model implementation when exploring different models. Data scientist just need to specify the models to be included, and then these models will be automatically tuned and evaluated. Keep in mind, AutoML is suitable for the initial model exploration but not for getting the best performing model. Once an appropriate model family is identified, further tuning is still required.   
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> h2o
<span style="color: #4f97d7; font-weight: bold;">from</span> h2o.automl <span style="color: #4f97d7; font-weight: bold;">import</span> H2OAutoML

<span style="color: #7590db;">train</span> = pd.read_csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'./data/data.csv'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">train.market_id</span> = train.market_id.astype<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"str"</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">train.order_protocol</span> = train.order_protocol.astype<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"str"</span><span style="color: #4f97d7;">)</span>

h2o.init<span style="color: #4f97d7;">()</span>
<span style="color: #7590db;">train</span> = h2o.H2OFrame<span style="color: #4f97d7;">(</span>train<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">x</span> = train.columns
x.remove<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'actual_delivery_time'</span><span style="color: #4f97d7;">)</span>
x.remove<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'created_at'</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">y</span> = <span style="color: #2d9574;">'duration'</span>
x.remove<span style="color: #4f97d7;">(</span>y<span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Run AutoML for 30 seconds</span>
<span style="color: #7590db;">aml</span> = H2OAutoML<span style="color: #4f97d7;">(</span>max_runtime_secs=<span style="color: #a45bad;">30</span><span style="color: #4f97d7;">)</span>
aml.train<span style="color: #4f97d7;">(</span>x=x, y=y, training_frame=train<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">View the AutoML Leaderboard</span>
<span style="color: #7590db;">lb</span> = aml.leaderboard
</pre>
</div>

<ul class="org-ul">
<li>Model comparison</li>
</ul>

<p>
As indicated by the following table, the best performing model is an ensemble model. This is a stacked ensemble model. Its algorithm can be found <a href="https://www.degruyter.com/view/j/sagmb.2007.6.issue-1/sagmb.2007.6.1.1309/sagmb.2007.6.1.1309.xml">here</a>. In short, stacked ensemble learning is a class of algorithms that involves training a second-level “metalearner” to find the optimal combination of the base learners. Unlike bagging and boosting, the goal in stacking is to ensemble strong, diverse sets of learners together.
I will use <code>StackedEnsemble_BestOfFamily</code> as the model for servnig. 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">model<sub>id</sub></th>
<th scope="col" class="org-right">mean<sub>residual</sub><sub>deviance</sub></th>
<th scope="col" class="org-right">rmse</th>
<th scope="col" class="org-right">mae</th>
<th scope="col" class="org-right">rmsle</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">StackedEnsemble<sub>AllModels</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub></td>
<td class="org-right">948309</td>
<td class="org-right">973.812</td>
<td class="org-right">625.31</td>
<td class="org-right">0.281234</td>
</tr>

<tr>
<td class="org-left">StackedEnsemble<sub>BestOfFamily</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub></td>
<td class="org-right">954067</td>
<td class="org-right">976.764</td>
<td class="org-right">626.901</td>
<td class="org-right">0.281996</td>
</tr>

<tr>
<td class="org-left">GBM<sub>grid</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub><sub>model</sub><sub>4</sub></td>
<td class="org-right">973542</td>
<td class="org-right">986.682</td>
<td class="org-right">636.629</td>
<td class="org-right">0.286368</td>
</tr>

<tr>
<td class="org-left">GBM<sub>grid</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub><sub>model</sub><sub>2</sub></td>
<td class="org-right">981859</td>
<td class="org-right">990.888</td>
<td class="org-right">641.478</td>
<td class="org-right">0.288185</td>
</tr>

<tr>
<td class="org-left">GBM<sub>grid</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub><sub>model</sub><sub>1</sub></td>
<td class="org-right">982456</td>
<td class="org-right">991.189</td>
<td class="org-right">641.57</td>
<td class="org-right">0.288078</td>
</tr>

<tr>
<td class="org-left">GBM<sub>grid</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub><sub>model</sub><sub>3</sub></td>
<td class="org-right">982967</td>
<td class="org-right">991.447</td>
<td class="org-right">641.205</td>
<td class="org-right">0.288238</td>
</tr>

<tr>
<td class="org-left">DeepLearning<sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub></td>
<td class="org-right">987368</td>
<td class="org-right">993.664</td>
<td class="org-right">640.402</td>
<td class="org-right">0.28797</td>
</tr>

<tr>
<td class="org-left">GBM<sub>grid</sub><sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub><sub>model</sub><sub>0</sub></td>
<td class="org-right">990865</td>
<td class="org-right">995.422</td>
<td class="org-right">646.579</td>
<td class="org-right">0.290066</td>
</tr>

<tr>
<td class="org-left">DRF<sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub></td>
<td class="org-right">1.05269e+06</td>
<td class="org-right">1026.01</td>
<td class="org-right">674.232</td>
<td class="org-right">0.302125</td>
</tr>

<tr>
<td class="org-left">XRT<sub>0</sub><sub>AutoML</sub><sub>20180731</sub><sub>024402</sub></td>
<td class="org-right">1.06259e+06</td>
<td class="org-right">1030.82</td>
<td class="org-right">679.858</td>
<td class="org-right">0.304129</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-org">
</pre>
</div>
</div>
</div>

<div id="outline-container-orga65264a" class="outline-3">
<h3 id="orga65264a"><span class="section-number-3">3.2</span> Mixed effects model</h3>
<div class="outline-text-3" id="text-3-2">
<p>
A generalized mixed effects model (GLMM) is represented as:
</p>

\begin{equation*}
g(\mu_{ij}) = x_{ij} \beta + z_{ij}b_i
\end{equation*} 
<p>
where g(·) is a monotonic “link” function, x<sub>ij</sub> is 1 × p, and z<sub>ij</sub> is 1 × q, with β a p × 1 vector of fixed effects and b<sub>i</sub> a q × 1 v ector of random effects
</p>

<p>
If we were to apply conventional GLMM, we would need to transform a vector of p
raw covariates X = (X<sub>1</sub>, &#x2026;, X<sub>p</sub>)<sup>T</sup> in the following way
</p>

\begin{equation*}
  φ(X) = (φ_1(X), ..., φ_m(X))
\end{equation*}

<p>
Usually in conventional GLMM, \(φ_j (X)\) are chosen <i>a priori</i> in some way. But here we are concerned with learning an appropriate \(φ_j (X)\) from data. If a deep multi-layer perceptron is used for transforming the covariates, then Z has the form
</p>


\begin{equation*}
f_L(W_L,f_{L-1}(W_{L-1},\cdots,f_1(W_1,X)\cdots))
\end{equation*}
<p>
which is often graphically represented by a network as in the following figure
<img src="./Figures/neural-net.png" alt="neural-net.png" />
 \(L\) is the number of hidden layers in the network, \(w=(W_1,...,W_L)\) is the set of weights
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #4f97d7; font-weight: bold;">as</span> plt
<span style="color: #4f97d7; font-weight: bold;">import</span> numpy <span style="color: #4f97d7; font-weight: bold;">as</span> np
<span style="color: #4f97d7; font-weight: bold;">import</span> pandas <span style="color: #4f97d7; font-weight: bold;">as</span> pd
<span style="color: #4f97d7; font-weight: bold;">import</span> tensorflow <span style="color: #4f97d7; font-weight: bold;">as</span> tf
<span style="color: #4f97d7; font-weight: bold;">from</span> keras <span style="color: #4f97d7; font-weight: bold;">import</span> backend <span style="color: #4f97d7; font-weight: bold;">as</span> K
<span style="color: #4f97d7; font-weight: bold;">from</span> keras.layers <span style="color: #4f97d7; font-weight: bold;">import</span> Dense, Input
<span style="color: #4f97d7; font-weight: bold;">from</span> keras.regularizers <span style="color: #4f97d7; font-weight: bold;">import</span> l2
<span style="color: #4f97d7; font-weight: bold;">from</span> mpl_toolkits.mplot3d <span style="color: #4f97d7; font-weight: bold;">import</span> Axes3D
<span style="color: #4f97d7; font-weight: bold;">from</span> sklearn.preprocessing <span style="color: #4f97d7; font-weight: bold;">import</span> scale

<span style="color: #4f97d7; font-weight: bold;">import</span> edward <span style="color: #4f97d7; font-weight: bold;">as</span> ed
<span style="color: #4f97d7; font-weight: bold;">from</span> edward.models <span style="color: #4f97d7; font-weight: bold;">import</span> Normal


<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">neural_network</span><span style="color: #4f97d7;">(</span>fixed_effects, lamd=.<span style="color: #a45bad;">1</span>, input_dim=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>:
    <span style="color: #7590db;">dense</span> = Dense<span style="color: #4f97d7;">(</span>
        <span style="color: #a45bad;">5</span>, activation=<span style="color: #2d9574;">'tanh'</span>, kernel_regularizer=l2<span style="color: #bc6ec5;">(</span>lamd<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)(</span>fixed_effects<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">output</span> = Dense<span style="color: #4f97d7;">(</span>
        <span style="color: #a45bad;">1</span>, activation=<span style="color: #2d9574;">'linear'</span>, name=<span style="color: #2d9574;">'output'</span>,
        kernel_regularizer=l2<span style="color: #bc6ec5;">(</span>lamd<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)(</span>dense<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> K.squeeze<span style="color: #4f97d7;">(</span>output, axis=<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)</span>


<span style="color: #7590db;">sess</span> = ed.get_session<span style="color: #4f97d7;">()</span>
K.set_session<span style="color: #4f97d7;">(</span>sess<span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">INIT_OP</span> = tf.global_variables_initializer<span style="color: #4f97d7;">()</span>

<span style="color: #7590db;">data</span> = pd.read_csv<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'~/Dropbox/Quantiply/playground/data.csv'</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">fixed_effect_predictors</span> = <span style="color: #4f97d7;">[</span>
    <span style="color: #2d9574;">'total_items'</span>, <span style="color: #2d9574;">'subtotal'</span>, <span style="color: #2d9574;">'num_distinct_items'</span>, <span style="color: #2d9574;">'min_item_price'</span>,
    <span style="color: #2d9574;">'max_item_price'</span>, <span style="color: #2d9574;">'total_onshift_dashers'</span>, <span style="color: #2d9574;">'total_busy_dashers'</span>,
    <span style="color: #2d9574;">'total_outstanding_orders'</span>, <span style="color: #2d9574;">'estimated_order_place_duration'</span>,
    <span style="color: #2d9574;">'estimated_store_to_consumer_driving_duration'</span>, <span style="color: #2d9574;">'hour_x'</span>, <span style="color: #2d9574;">'hour_y'</span>
<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">zip_codes</span> = data<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'market_id'</span><span style="color: #4f97d7;">]</span>.astype<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'category'</span><span style="color: #4f97d7;">)</span>.cat.codes + <span style="color: #a45bad;">1</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">zip_codes.value_counts()</span>
<span style="color: #7590db;">train_index</span> = data.sample<span style="color: #4f97d7;">(</span>frac=<span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">7</span><span style="color: #4f97d7;">)</span>.index
<span style="color: #7590db;">val_index</span> = data.drop<span style="color: #4f97d7;">(</span>train_index<span style="color: #4f97d7;">)</span>.index

<span style="color: #7590db;">X</span> = data.drop<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'duration'</span>, axis=<span style="color: #a45bad;">1</span><span style="color: #4f97d7;">)[</span>fixed_effect_predictors<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">X</span> = scale<span style="color: #4f97d7;">(</span>X<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">y</span> = data<span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'duration'</span><span style="color: #4f97d7;">]</span>.values
<span style="color: #7590db;">X_train</span> = X<span style="color: #4f97d7;">[</span>train_index<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">y_train</span> = y<span style="color: #4f97d7;">[</span>train_index<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">X_val</span> = X<span style="color: #4f97d7;">[</span>val_index<span style="color: #4f97d7;">]</span>
<span style="color: #7590db;">y_val</span> = y<span style="color: #4f97d7;">[</span>val_index<span style="color: #4f97d7;">]</span>

<span style="color: #7590db;">N</span>, <span style="color: #7590db;">D</span> = X_train.shape

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">fixed-effects placeholders</span>
<span style="color: #7590db;">fixed_effects</span> = tf.placeholder<span style="color: #4f97d7;">(</span>tf.float32, <span style="color: #bc6ec5;">[</span>N, D<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">fixed-effects parameters</span>
<span style="color: #7590db;">b_fixed_effects</span> = Normal<span style="color: #4f97d7;">(</span>loc=tf.zeros<span style="color: #bc6ec5;">(</span>D<span style="color: #bc6ec5;">)</span>, scale=tf.ones<span style="color: #bc6ec5;">(</span>D<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">a</span> = Normal<span style="color: #4f97d7;">(</span>loc=tf.zeros<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span>, scale=tf.ones<span style="color: #bc6ec5;">(</span><span style="color: #a45bad;">1</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">approximate fixed-effects distributions</span>
<span style="color: #7590db;">qb_fixed_effects</span> = Normal<span style="color: #4f97d7;">(</span>
    loc=tf.Variable<span style="color: #bc6ec5;">(</span>tf.random_normal<span style="color: #2d9574;">(</span><span style="color: #67b11d;">[</span>D<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>,
    scale=tf.nn.softplus<span style="color: #bc6ec5;">(</span>tf.Variable<span style="color: #2d9574;">(</span>tf.random_normal<span style="color: #67b11d;">(</span><span style="color: #b1951d;">[</span>D<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">qa</span> = Normal<span style="color: #4f97d7;">(</span>
    loc=tf.Variable<span style="color: #bc6ec5;">(</span>tf.random_normal<span style="color: #2d9574;">(</span><span style="color: #67b11d;">[</span><span style="color: #a45bad;">1</span><span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>,
    scale=tf.nn.softplus<span style="color: #bc6ec5;">(</span>tf.Variable<span style="color: #2d9574;">(</span>tf.random_normal<span style="color: #67b11d;">(</span><span style="color: #b1951d;">[</span><span style="color: #a45bad;">1</span><span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">n_zip_codes</span> = <span style="color: #4f97d7;">len</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7;">set</span><span style="color: #bc6ec5;">(</span>zip_codes<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">random-effect placeholder</span>
<span style="color: #7590db;">zip_codes_ph</span> = tf.placeholder<span style="color: #4f97d7;">(</span>tf.int32, <span style="color: #bc6ec5;">[</span>N<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">random-effect parameter</span>
<span style="color: #7590db;">sigm_zip_code</span> = tf.sqrt<span style="color: #4f97d7;">(</span>tf.exp<span style="color: #bc6ec5;">(</span>tf.Variable<span style="color: #2d9574;">(</span>tf.random_normal<span style="color: #67b11d;">(</span><span style="color: #b1951d;">[]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">a_zip_code</span> = Normal<span style="color: #4f97d7;">(</span>
    loc=tf.zeros<span style="color: #bc6ec5;">(</span>n_zip_codes<span style="color: #bc6ec5;">)</span>, scale=sigm_zip_code * tf.ones<span style="color: #bc6ec5;">(</span>n_zip_codes<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">approximate random-effect distribution</span>
<span style="color: #7590db;">qa_zip_code</span> = Normal<span style="color: #4f97d7;">(</span>
    loc=tf.Variable<span style="color: #bc6ec5;">(</span>tf.random_normal<span style="color: #2d9574;">(</span><span style="color: #67b11d;">[</span>n_zip_codes<span style="color: #67b11d;">]</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>,
    scale=tf.nn.softplus<span style="color: #bc6ec5;">(</span>tf.Variable<span style="color: #2d9574;">(</span>tf.random_normal<span style="color: #67b11d;">(</span><span style="color: #b1951d;">[</span>n_zip_codes<span style="color: #b1951d;">]</span><span style="color: #67b11d;">)</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>

<span style="color: #7590db;">a_random_effects</span> = tf.gather<span style="color: #4f97d7;">(</span>a_zip_code, zip_codes_ph<span style="color: #4f97d7;">)</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">### Infer parameters</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">model</span>
<span style="color: #7590db;">fixed_effects</span> = tf.placeholder<span style="color: #4f97d7;">(</span>tf.float32, <span style="color: #bc6ec5;">[</span>N, D<span style="color: #bc6ec5;">]</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">mu_y</span> = a + a_random_effects + neural_network<span style="color: #4f97d7;">(</span>fixed_effects<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">y</span> = Normal<span style="color: #4f97d7;">(</span>loc=mu_y, scale=tf.ones<span style="color: #bc6ec5;">(</span>N<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">latent_vars</span> = <span style="color: #4f97d7;">{</span>
    b_fixed_effects: qb_fixed_effects,
    a: qa,
    a_zip_code: qa_zip_code
<span style="color: #4f97d7;">}</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Inference</span>
sess.run<span style="color: #4f97d7;">(</span>INIT_OP<span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">inference</span> = ed.KLqp<span style="color: #4f97d7;">(</span>
    latent_vars,
    data=<span style="color: #bc6ec5;">{</span>
        fixed_effects: X_train,
        zip_codes_ph: zip_codes<span style="color: #2d9574;">[</span>train_index<span style="color: #2d9574;">]</span>,
        y: y_train
    <span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">optimizer</span> = tf.train.RMSPropOptimizer<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">0</span>.<span style="color: #a45bad;">01</span>, epsilon=<span style="color: #a45bad;">1</span>.<span style="color: #a45bad;">0</span><span style="color: #4f97d7;">)</span>
inference.initialize<span style="color: #4f97d7;">(</span>optimizer=optimizer<span style="color: #4f97d7;">)</span>
inference.run<span style="color: #4f97d7;">(</span>n_samples=<span style="color: #a45bad;">5</span>, n_iter=<span style="color: #a45bad;">1000</span><span style="color: #4f97d7;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb4588a4" class="outline-2">
<h2 id="orgb4588a4"><span class="section-number-2">4</span> Prediction</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org243e78c" class="outline-3">
<h3 id="org243e78c"><span class="section-number-3">4.1</span> Script for model serving</h3>
<div class="outline-text-3" id="text-4-1">
<p>
For the neural network based mixed effects model, since it is implemented in tensorflow, it can be served via tf.serving. A few advantages of tf.serving are:
</p>

<ul class="org-ul">
<li>Scales to massive data.</li>
<li>Supports online learning.</li>
<li>Supports batch training.</li>
</ul>

<p>
The script I will use for model serving is shown below. If I had more time, I would have built a <a href="https://www.docker.com/">docker</a> container for portability.
</p>
<div class="org-src-container">
<pre class="src src-ipython"><span style="color: #4f97d7; font-weight: bold;">import</span> argparse
<span style="color: #4f97d7; font-weight: bold;">import</span> math
<span style="color: #4f97d7; font-weight: bold;">import</span> os

<span style="color: #4f97d7; font-weight: bold;">import</span> h2o
<span style="color: #4f97d7; font-weight: bold;">import</span> pandas <span style="color: #4f97d7; font-weight: bold;">as</span> pd

<span style="color: #7590db;">parser</span> = argparse.ArgumentParser<span style="color: #4f97d7;">()</span>
parser.add_argument<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"--input_path"</span>, default=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>
parser.add_argument<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"--model_path"</span>, default=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>
parser.add_argument<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"--output_path"</span>, default=<span style="color: #a45bad;">None</span><span style="color: #4f97d7;">)</span>
<span style="color: #7590db;">ms</span> = parser.parse_args<span style="color: #4f97d7;">()</span>


<span style="color: #4f97d7; font-weight: bold;">if</span> ms.input_path <span style="color: #4f97d7; font-weight: bold;">is</span> <span style="color: #a45bad;">None</span>:
    <span style="color: #4f97d7; font-weight: bold;">raise</span> <span style="color: #ce537a; font-weight: bold;">ValueError</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Please provide the path of your input data.'</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> ms.model_path <span style="color: #4f97d7; font-weight: bold;">is</span> <span style="color: #a45bad;">None</span>:
    <span style="color: #4f97d7; font-weight: bold;">raise</span> <span style="color: #ce537a; font-weight: bold;">ValueError</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Please provide the path of the model file.'</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> ms.output_path <span style="color: #4f97d7; font-weight: bold;">is</span> <span style="color: #a45bad;">None</span>:
    <span style="color: #4f97d7; font-weight: bold;">raise</span> <span style="color: #ce537a; font-weight: bold;">ValueError</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Please provide the path to save the results.'</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> os.path.isdir<span style="color: #4f97d7;">(</span>ms.input_path<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">raise</span> <span style="color: #ce537a; font-weight: bold;">IOError</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Provided input path is a directory. \</span>
<span style="color: #2d9574;">Please provide the path to the data file.'</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> os.path.isdir<span style="color: #4f97d7;">(</span>ms.model_path<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">raise</span> <span style="color: #ce537a; font-weight: bold;">IOError</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Provided model path is a directory. \</span>
<span style="color: #2d9574;">Please provide the path to the model file.'</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> os.path.isdir<span style="color: #4f97d7;">(</span>ms.output_path<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">raise</span> <span style="color: #ce537a; font-weight: bold;">IOError</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">'Provided output path is a directory.\</span>
<span style="color: #2d9574;">Please specify the file path to store the results.'</span><span style="color: #4f97d7;">)</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Initialize h2o</span>
h2o.init<span style="color: #4f97d7;">()</span>

<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">define functions to engineer the feature hour</span>
<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">hour_x</span><span style="color: #4f97d7;">(</span>hour<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> math.sin<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span> * math.pi * hour / <span style="color: #a45bad;">24</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">hour_y</span><span style="color: #4f97d7;">(</span>hour<span style="color: #4f97d7;">)</span>:
    <span style="color: #4f97d7; font-weight: bold;">return</span> math.cos<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">2</span> * math.pi * hour / <span style="color: #a45bad;">24</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">prepare_test_data</span><span style="color: #4f97d7;">(</span>input_path=ms.input_path<span style="color: #4f97d7;">)</span>:
    <span style="color: #9f8766;">'''Prepare the test dataset</span>

<span style="color: #9f8766;">    Parameters</span>
<span style="color: #9f8766;">    ----------</span>
<span style="color: #9f8766;">    input_path: str</span>
<span style="color: #9f8766;">        Path to the saved input data.</span>

<span style="color: #9f8766;">    Returns</span>
<span style="color: #9f8766;">    -------</span>
<span style="color: #9f8766;">    test: H2O.DataFrame</span>
<span style="color: #9f8766;">        Test dataset after the same feature engineering. </span>
<span style="color: #9f8766;">    '''</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">jason_path = '../../Data Science/data_to_predict.json'</span>
<span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">test = pd.read_json(jason_path, lines = True)</span>
    <span style="color: #7590db;">test</span> = pd.read_json<span style="color: #4f97d7;">(</span>input_path, lines=<span style="color: #a45bad;">True</span><span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #2d9574;">'Using input data from %s'</span> % input_path
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">Engineer the features of test data accordingly</span>
    <span style="color: #7590db;">test.created_at</span> = pd.to_datetime<span style="color: #4f97d7;">(</span>test.created_at<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">test</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'weekday'</span><span style="color: #4f97d7;">]</span> = test.created_at.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x.weekday<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">test</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'hour'</span><span style="color: #4f97d7;">]</span> = test.created_at.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span><span style="color: #4f97d7; font-weight: bold;">lambda</span> x: x.hour<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">test</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'hour_x'</span><span style="color: #4f97d7;">]</span> = test.hour.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span>hour_x<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">test</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'hour_y'</span><span style="color: #4f97d7;">]</span> = test.hour.<span style="color: #4f97d7;">map</span><span style="color: #4f97d7;">(</span>hour_y<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">test</span> = h2o.H2OFrame<span style="color: #4f97d7;">(</span>test<span style="color: #4f97d7;">)</span>
    <span style="color: #4f97d7; font-weight: bold;">return</span> test

<span style="color: #4f97d7; font-weight: bold;">def</span> <span style="color: #bc6ec5; font-weight: bold;">predict</span><span style="color: #4f97d7;">(</span>model_path=ms.model_path,
            output_path=ms.output_path<span style="color: #4f97d7;">)</span>:
    <span style="color: #9f8766;">'''Make predictions</span>

<span style="color: #9f8766;">    Parameters</span>
<span style="color: #9f8766;">    ----------</span>
<span style="color: #9f8766;">    model_path: str</span>
<span style="color: #9f8766;">        Path to the saved model file.</span>
<span style="color: #9f8766;">    output_path: str</span>
<span style="color: #9f8766;">        Path to save the results.</span>

<span style="color: #9f8766;">    Returns</span>
<span style="color: #9f8766;">    -------</span>
<span style="color: #9f8766;">    None</span>
<span style="color: #9f8766;">    '''</span>
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">load the saved model</span>
    <span style="color: #7590db;">aml_top</span> = h2o.load_model<span style="color: #4f97d7;">(</span>model_path<span style="color: #4f97d7;">)</span>
    <span style="color: #2aa1ae; background-color: #292e34;"># </span><span style="color: #2aa1ae; background-color: #292e34;">make predictions</span>
    <span style="color: #7590db;">test</span> = prepare_test_data<span style="color: #4f97d7;">()</span>
    <span style="color: #7590db;">pred</span> = aml_top.predict<span style="color: #4f97d7;">(</span>test<span style="color: #4f97d7;">)</span>
    <span style="color: #7590db;">res</span> = pd.DataFrame<span style="color: #4f97d7;">()</span>
    <span style="color: #7590db;">res</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'delivery_id'</span><span style="color: #4f97d7;">]</span> = test.as_data_frame<span style="color: #4f97d7;">()[</span><span style="color: #2d9574;">'delivery_id'</span><span style="color: #4f97d7;">]</span>
    <span style="color: #7590db;">res</span><span style="color: #4f97d7;">[</span><span style="color: #2d9574;">'predicted_delivery_seconds'</span><span style="color: #4f97d7;">]</span> = pred.as_data_frame<span style="color: #4f97d7;">()[</span><span style="color: #2d9574;">'predict'</span><span style="color: #4f97d7;">]</span>
    res.to_csv<span style="color: #4f97d7;">(</span>output_path, sep=<span style="color: #2d9574;">'\t'</span>, index=<span style="color: #a45bad;">False</span><span style="color: #4f97d7;">)</span>

<span style="color: #4f97d7; font-weight: bold;">if</span> <span style="color: #4f97d7;">__name__</span> == <span style="color: #2d9574;">"__main__"</span>:
    predict<span style="color: #4f97d7;">()</span>
    h2o.cluster<span style="color: #4f97d7;">()</span>.shutdown<span style="color: #4f97d7;">()</span>
    <span style="color: #4f97d7; font-weight: bold;">print</span> <span style="color: #2d9574;">'Saving results to %s'</span> % ms.output_path
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Qike Max Li</p>
<p class="date">Created: 2018-07-31 Tue 09:16</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
